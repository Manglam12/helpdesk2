<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, user-scalable=no" />
    <title>Helpdesk</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" type="text/css" href="assets/css/style.css">
    <!-- Custom JavaScript -->
    <script src="assets/js/script.js"></script>
    <!-- MD5 Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.19.0/js/md5.min.js"></script>
    <style>
        #error_msg{
            color: red;
        }
    </style>
</head>
<body onload="checkLogin()">
<header class="navbar navbar-expand-md d-flex flex-wrap justify-content-center p-3 mb-2 border-bottom">
    <div class="container-fluid">
        <a href="#" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto link-body-emphasis text-decoration-none">
            <img src="assets/images/logo.png" id="imglogo">
            <span class="fs-4 mr-5 lo"><h2 class="bold-text">Helpdesk</h2></span>
        </a>
    </div>
</header>

<div id="body">
    
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Login/Signup
                    </div>
                    <div class="card-body">
                        <form id="loginForm" onsubmit="submitForm(event)">
                            <div class="form-group mb-2">
                                <label for="name">Name</label>
                                <input type="text" class="form-control" id="name" placeholder="Enter your name">
                            </div>
                            <div class="form-group mb-2">
                                <label for="email">Email address</label>
                                <input type="email" class="form-control" id="email" placeholder="Enter email">
                            </div>
                            <div class="form-group mb-2">
                                <label for="password">Password</label>
                                <input type="password" class="form-control" id="password" placeholder="Password" required autocomplete="current-password">
                            </div>
                            <div class="form-group mb-2">
                                <label for="semester">Select Year</label>
                                <select class="form-control" id="year">
                                    <option value="1">Year 1</option>
                                    <option value="2">Year 2</option>
                                    <option value="3">Year 3</option>
                                    <option value="4">Year 4</option>
                                    
                                </select>
                            </div>

                           
                                <br>
                                <a href="forgetpass.html">Forget Password</a><br> <center>
                                <button type="submit" class="btn btn-primary" id="btn_login">Login</button></center>
                        </form>
                        <div id="error_msg"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS and dependencies (Popper.js and Bootstrap bundle) -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js" integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Function to delete all cookies
function deleteAllCookies() {
    const cookies = document.cookie.split(";");
    for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i];
        const eqPos = cookie.indexOf("=");
        const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
        document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/"; // Delete each cookie
    }
}

// Function to set a new cookie
function setCookie(name, value, days = 7) {
    let expires = "";
    if (days) {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000)); // Set expiration
        expires = "; expires=" + date.toUTCString();
    }
    document.cookie = name + "=" + (value || "") + expires + "; path=/; SameSite=Lax";
}

// Function to check if a specific cookie is set
function isCookieSet(name) {
    return getCookie(name) !== null;
}

// Function to get a cookie value
function getCookie(name) {
    const nameEQ = name + "=";
    const ca = document.cookie.split(';');
    for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') {
            c = c.substring(1, c.length);
        }
        if (c.indexOf(nameEQ) === 0) {
            return c.substring(nameEQ.length, c.length);
        }
    }
    return null;
}

// Modified submitForm function
async function submitForm(event) {
    event.preventDefault(); // Prevent default form submission

    const submitButton = document.getElementById("btn_login");
    submitButton.disabled = true;

    const name = document.getElementById('name').value.trim();
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    const year = document.getElementById('year').value.trim();

    if (name === "" || email === "" || password === "" || year === "") {
        er_msg("Fill in all the details");
        submitButton.disabled = false;
        return;
    }

    try {
        const apiUrl = 'https://arambhsoftech.com/Helpdesk/new_user.php';

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ name, email, password, year })
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Error ${response.status}: ${errorText}`);
        }

        const data = await response.json();
        console.log('Server response:', data);

        if (data.status === 'login') {
            handleLoginSuccess(data);
        } else if (data.status === 'registration') {
            // Delete all existing cookies
            deleteAllCookies();

            // Set new cookies and wait until they are confirmed to be set
            setLoginCookies({ name, email, year });

            // Wait until the cookies are set before redirecting
            const checkCookiesSet = new Promise((resolve, reject) => {
                let attempts = 0;
                const interval = setInterval(() => {
                    if (isCookieSet('user_email') && isCookieSet('user_year')) {
                        clearInterval(interval);
                        resolve();
                    } else if (attempts++ > 10) { // Timeout after 10 attempts (~2 seconds)
                        clearInterval(interval);
                        reject(new Error('Cookie setting timed out.'));
                    }
                }, 200); // Check every 200ms
            });

            // Wait for cookie confirmation, then redirect
            await checkCookiesSet;
            redirectToYearPage(data.year);
        } else {
            throw new Error('Unexpected response format');
        }
    } catch (error) {
        console.error('Error:', error);
        handleErrors(error);
        clearForm();
    } finally {
        submitButton.disabled = false;
    }
}

// Function to handle successful login (if required)
function handleLoginSuccess(data) {
    setCookie('user_name', data.name);
    setCookie('user_email', data.email);
    setCookie('user_year', data.year);
    setCookie('c_user', 'true');

    setTimeout(() => {
        redirectToYearPage(data.year);
    }, 4000);
}

// Function to set multiple login-related cookies
function setLoginCookies({ name, email, year }) {
    setCookie('user_name', name);
    setCookie('user_email', email);
    setCookie('user_year', year);
    setCookie('c_user', 'true');
}

</script>




</body>
</html>
